<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>
        <%= title %>
    </title>

    <!-- Fonts & Styles -->
    <link href="/vendor/fontawesome-free/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Nunito:200,300,400,600,700,800,900" rel="stylesheet">
    <link href="/css/sb-admin-2.min.css" rel="stylesheet">
</head>

<body id="page-top">

    <!-- Page Wrapper -->
    <div id="wrapper">

        <!-- Sidebar -->
        <%- include('../layouts/staffSidebar.ejs') %>
            <!-- End Sidebar -->

            <!-- Content Wrapper -->
            <div id="content-wrapper" class="d-flex flex-column">

                <!-- Main Content -->
                <div id="content">

                    <!-- Topbar -->
                    <%- include('../layouts/navbar.ejs') %>
                        <!-- End Topbar -->

                        <div class="container-fluid">
                            <link rel="stylesheet" href="/css/chat.css">
                            <!-- Start of Original Chat Code -->

                            <script src="/socket.io/socket.io.js"></script>

                            <div class="chat-header">
                                <h1>
                                    <%= title %>
                                </h1>
                                <p>Welcome, <%= staffName || 'Staff' %> (ID: <%= staffId %>)</p>
                                <div class="connection-status" id="connectionStatus">
                                    Connecting to server...
                                </div>
                                <!-- <div class="debug-tools">
                                    <button class="debug-btn" onclick="debugRooms()">üîß Debug Rooms</button>
                                    <button class="debug-btn" onclick="debugConnection()">üîç Debug Connection</button>
                                    <button class="debug-btn" onclick="sendTestMessage()">üì§ Test Message</button>
                                    <button class="debug-btn" onclick="window.open('/debug-connections', '_blank')">üìä
                                        Server Debug</button>
                                </div> -->
                            </div>

                            <div class="chat-main">
                                <div class="sidebar2">
                                    <div class="patient-connect">
                                        <h3>Connect to Patient</h3>
                                        <div class="input-group">
                                            <input type="text" id="patientIdInput"
                                                placeholder="Enter Patient ID (e.g., 001)">
                                            <button onclick="connectToPatient()" id="connectBtn">
                                                Connect
                                            </button>
                                        </div>
                                        <p style="font-size: 12px; color: #666; margin-top: 5px;">
                                            Enter just the number (001), not "patient-001"
                                        </p>
                                    </div>

                                    <div class="patient-list">
                                        <h3>Connected Patients</h3>
                                        <div id="activePatients">
                                            <!-- Patient list will be populated here -->
                                        </div>
                                    </div>
                                </div>

                                <div class="chat-area">
                                    <div class="current-patient-info" id="currentPatientInfo">
                                        <h3>No patient selected</h3>
                                        <p>Please connect to a patient to start chatting</p>
                                    </div>

                                    <div class="messages-container" id="messagesContainer">
                                        <!-- Messages will appear here -->
                                        <div class="message received">
                                            <div class="message-header">
                                                <strong>System</strong> ‚Ä¢ Just now
                                            </div>
                                            <div>Welcome to the chat! Connect to a patient to start messaging.</div>
                                        </div>
                                    </div>

                                    <div id="typingIndicator" class="typing-indicator">
                                        Patient is typing...
                                    </div>

                                    <div class="input-area">
                                        <input type="text" id="messageInput" placeholder="Type your message here..."
                                            onkeypress="handleKeyPress(event)" disabled>
                                        <button class="send-button" onclick="sendMessage()" id="sendBtn" disabled>
                                            Send
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <!-- End of Original Chat Code -->

                        </div>
                        <!-- /.container-fluid -->

                </div>
                <!-- End of Main Content -->

                <!-- Footer -->
                <%- include('../layouts/footer.ejs') %>
                    <!-- End Footer -->

            </div>
            <!-- End of Content Wrapper -->

    </div>
    <!-- End of Page Wrapper -->

    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top"><i class="fas fa-angle-up"></i></a>

    <!-- Logout Modal-->
    <%- include('../layouts/modal.ejs') %>

        <!-- Scripts -->
        <script src="/vendor/jquery/jquery.min.js"></script>
        <script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
        <script src="/vendor/jquery-easing/jquery.easing.min.js"></script>
        <script src="/js/sb-admin-2.min.js"></script>
        <script src="/vendor/chart.js/Chart.min.js"></script>
        <script src="/js/demo/chart-area-demo.js"></script>
        <script src="/js/demo/chart-pie-demo.js"></script>


        <script>
            // Staff information from EJS template
            const staffId = '<%= staffId %>';
            const staffName = '<%= staffName || "Staff" %>';

            // Socket.IO configuration
            let socket = null;
            let currentPatientId = null;
            let currentPatientName = null;
            let isConnected = false;

            // Initialize socket connection
            function initializeSocket() {
                // Connect to Socket.IO server
                socket = io({
                    transports: ['websocket', 'polling'],
                    withCredentials: true
                });

                // Connection events
                socket.on('connect', () => {
                    console.log('‚úÖ Connected to server with ID:', socket.id);
                    isConnected = true;
                    updateConnectionStatus(true);

                    // Join as staff
                    socket.emit('staff-join', {
                        staffId: staffId,
                        name: staffName
                    });

                    // Enable input fields
                    document.getElementById('messageInput').disabled = false;
                    document.getElementById('sendBtn').disabled = false;
                    document.getElementById('connectBtn').disabled = false;
                });

                socket.on('disconnect', () => {
                    console.log('‚ùå Disconnected from server');
                    isConnected = false;
                    updateConnectionStatus(false);

                    // Disable input fields
                    document.getElementById('messageInput').disabled = true;
                    document.getElementById('sendBtn').disabled = true;
                    document.getElementById('connectBtn').disabled = true;
                });

                socket.on('connect_error', (error) => {
                    console.error('‚ùå Connection error:', error);
                    updateConnectionStatus(false);
                });

                socket.on('connected', (data) => {
                    console.log('üîå Server connected:', data);
                });

                socket.on('staff-joined', (data) => {
                    console.log('‚úÖ Staff joined successfully:', data);
                });

                // Listen for messages from patients
                socket.on('message-from-patient', (data) => {
                    console.log('üì© Message from patient:', data);

                    if (data.patientId === currentPatientId) {
                        // Display message in chat
                        displayMessage(data.patientName || 'Patient', data.message, false, data.timestamp);

                        // Hide typing indicator
                        document.getElementById('typingIndicator').style.display = 'none';
                    } else {
                        // Update patient list with notification
                        updatePatientNotification(data.patientId);

                        // Show notification
                        showNotification(`New message from ${data.patientName || 'Patient'}`);
                    }
                });

                socket.on('message-sent', (data) => {
                    console.log('üì§ Message sent confirmation:', data);
                });

                socket.on('user-typing', (data) => {
                    if (data.userId === currentPatientId) {
                        document.getElementById('typingIndicator').style.display = 'block';
                        document.getElementById('typingIndicator').textContent = `${data.userName || 'Patient'} is typing...`;

                        // Hide after 1 second
                        setTimeout(() => {
                            document.getElementById('typingIndicator').style.display = 'none';
                        }, 1000);
                    }
                });

                socket.on('error', (data) => {
                    console.error('‚ùå Socket error:', data);
                    alert('Error: ' + (data.message || 'Unknown error'));
                });
            }

            // Update connection status display
            function updateConnectionStatus(connected) {
                const statusElement = document.getElementById('connectionStatus');
                if (connected) {
                    statusElement.innerHTML = '<span class="connected">‚úÖ Connected to chat server</span>';
                    statusElement.className = 'connection-status connected';
                } else {
                    statusElement.innerHTML = '<span class="disconnected">‚ùå Disconnected from server</span>';
                    statusElement.className = 'connection-status disconnected';
                }
            }

            // Connect to a specific patient
            function connectToPatient() {
                const patientIdInput = document.getElementById('patientIdInput').value.trim();
                if (!patientIdInput) {
                    alert('Please enter a patient ID');
                    return;
                }

                if (!isConnected) {
                    alert('Not connected to server. Please wait...');
                    return;
                }

                // Clean patient ID - just keep numbers
                let cleanPatientId = patientIdInput.replace('patient-', '').trim();

                currentPatientId = cleanPatientId;
                currentPatientName = 'Patient ' + cleanPatientId;

                // Update UI
                document.getElementById('currentPatientInfo').innerHTML = `
                <h3>Chatting with: ${currentPatientName}</h3>
                <p>Patient ID: ${cleanPatientId}</p>
                <p><small>Room: patient-${cleanPatientId}</small></p>
            `;

                // Clear chat messages
                document.getElementById('messagesContainer').innerHTML = '';

                // Add welcome message
                displayMessage('System', `Connected to patient ${cleanPatientId}. Start chatting!`, false, new Date().toISOString());

                // Add to patient list
                addToPatientList(cleanPatientId, currentPatientName);

                // Clear input
                document.getElementById('patientIdInput').value = '';

                // Focus on message input
                document.getElementById('messageInput').focus();

                console.log(`Connected to patient: ${cleanPatientId}`);
                console.log(`Will send to room: patient-${cleanPatientId}`);
            }

            // Add patient to sidebar list
            function addToPatientList(patientId, patientName) {
                const patientList = document.getElementById('activePatients');
                const existingPatient = document.getElementById(`patient-${patientId}`);

                if (!existingPatient) {
                    const patientElement = document.createElement('div');
                    patientElement.className = 'patient-item';
                    patientElement.id = `patient-${patientId}`;
                    patientElement.innerHTML = `
                    <div>
                        <span class="status-indicator status-online"></span>
                        <strong>${patientName}</strong>
                    </div>
                    <span class="unread-count" id="unread-${patientId}" style="display: none;">0</span>
                `;
                    patientElement.onclick = () => {
                        setActivePatient(patientId, patientName);
                    };
                    patientList.appendChild(patientElement);
                }
            }

            // Set active patient
            function setActivePatient(patientId, patientName) {
                currentPatientId = patientId;
                currentPatientName = patientName;

                // Update UI
                document.getElementById('currentPatientInfo').innerHTML = `
                <h3>Chatting with: ${patientName}</h3>
                <p>Patient ID: ${patientId}</p>
            `;

                // Update patient list styling
                document.querySelectorAll('.patient-item').forEach(item => {
                    item.classList.remove('active');
                });
                const patientElement = document.getElementById(`patient-${patientId}`);
                if (patientElement) {
                    patientElement.classList.add('active');

                    // Clear unread count
                    const unreadElement = document.getElementById(`unread-${patientId}`);
                    if (unreadElement) {
                        unreadElement.style.display = 'none';
                    }
                }

                console.log(`Active patient set to: ${patientId}`);
            }

            // Send message to current patient
            function sendMessage() {
                const messageInput = document.getElementById('messageInput');
                const message = messageInput.value.trim();

                if (!message) {
                    alert('Please enter a message');
                    return;
                }

                if (!currentPatientId) {
                    alert('Please select a patient first');
                    return;
                }

                if (!isConnected || !socket) {
                    alert('Not connected to server. Please wait...');
                    return;
                }

                // Send message to patient
                socket.emit('staff-to-patient', {
                    patientId: currentPatientId,  // Just the number (e.g., "001")
                    staffId: staffId,
                    staffName: staffName,
                    message: message
                });

                // Display message in chat
                displayMessage('You', message, true, new Date().toISOString());

                // Clear input
                messageInput.value = '';
                messageInput.focus();
            }

            // Display message in chat container
            function displayMessage(sender, message, isSent, timestamp) {
                const messagesContainer = document.getElementById('messagesContainer');
                const messageElement = document.createElement('div');
                messageElement.className = `message ${isSent ? 'sent' : 'received'}`;

                const time = timestamp ? new Date(timestamp) : new Date();
                const timeString = time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                messageElement.innerHTML = `
                <div class="message-header">
                    <strong>${sender}</strong> ‚Ä¢ ${timeString}
                </div>
                <div>${message}</div>
            `;

                messagesContainer.appendChild(messageElement);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            // Handle key press in message input
            function handleKeyPress(event) {
                if (event.key === 'Enter') {
                    sendMessage();
                } else if (currentPatientId && socket) {
                    // Send typing indicator
                    socket.emit('typing', {
                        target: `patient-${currentPatientId}`,
                        isTyping: true,
                        userId: currentPatientId
                    });
                }
            }

            // Update notification badge for patient
            function updatePatientNotification(patientId) {
                const unreadElement = document.getElementById(`unread-${patientId}`);
                if (unreadElement) {
                    let currentCount = parseInt(unreadElement.textContent) || 0;
                    unreadElement.textContent = currentCount + 1;
                    unreadElement.style.display = 'inline-block';
                }
            }

            // Debug functions
            function debugRooms() {
                if (socket) {
                    socket.emit('get-rooms');
                    socket.once('rooms-list', (data) => {
                        console.log('üìä All rooms:', data);

                        // Filter patient rooms
                        const patientRooms = data.rooms.filter(room =>
                            room.name.startsWith('patient-')
                        );

                        alert(
                            `Debug Rooms Info:\n` +
                            `Total rooms: ${data.total}\n` +
                            `Patient rooms: ${patientRooms.length}\n` +
                            `Current patient: ${currentPatientId || 'None'}\n` +
                            `Your staff room: staff-${staffId}\n\n` +
                            `Patient rooms:\n${patientRooms.map(r => `‚Ä¢ ${r.name} (${r.clients} clients)`).join('\n')}`
                        );
                    });
                } else {
                    alert('Socket not connected');
                }
            }

            function debugConnection() {
                console.log('üîç Connection debug:', {
                    connected: isConnected,
                    socket: socket ? 'exists' : 'null',
                    staffId: staffId,
                    currentPatientId: currentPatientId
                });

                alert(
                    `Connection Status:\n` +
                    `‚Ä¢ Connected: ${isConnected ? '‚úÖ Yes' : '‚ùå No'}\n` +
                    `‚Ä¢ Socket: ${socket ? '‚úÖ Active' : '‚ùå Null'}\n` +
                    `‚Ä¢ Staff ID: ${staffId}\n` +
                    `‚Ä¢ Current Patient: ${currentPatientId || 'None'}`
                );
            }

            function sendTestMessage() {
                if (!currentPatientId) {
                    alert('Please connect to a patient first');
                    return;
                }

                const testMessage = `Test message at ${new Date().toLocaleTimeString()}`;

                socket.emit('staff-to-patient', {
                    patientId: currentPatientId,
                    staffId: staffId,
                    staffName: staffName,
                    message: testMessage
                });

                displayMessage('You (TEST)', testMessage, true, new Date().toISOString());

                console.log('Test message sent to:', currentPatientId);
            }

            // Show notification
            function showNotification(message) {
                console.log('üîî Notification:', message);
                if (Notification.permission === 'granted') {
                    new Notification('New Message', { body: message });
                }
            }

            // Request notification permission
            if (Notification.permission === 'default') {
                Notification.requestPermission();
            }

            // Initialize socket when page loads
            window.addEventListener('DOMContentLoaded', initializeSocket);
        </script>
</body>

</html>